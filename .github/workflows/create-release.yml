name: Create Release

# Manual trigger only
on: [workflow_dispatch]

jobs:
  tag-and-publish:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [lts/*]

    steps:
    - uses: newrelic/node-newrelic/.github/workflows/release-creation.yml@main
    # npm ci and getting tag is redundant from the reusable workflow `release-creation`
    # but all that work was done on the child repo in `agent-repo` folder and didn't
    # want to update the system config and publishing API docs
    - name: Install Dependencies
      run: npm ci
    - name: Get Created Tag
      id: get_tag
      run: echo "::set-output name=latest_tag::$(git describe --tags --abbrev=0)"
    - name: Update system configuration pages
      run: node ./bin/update-system-config-pages.js --version ${{ steps.get_tag.outputs.latest_tag }} --staging-key ${{ secrets.NEW_RELIC_API_KEY_STAGING }} --prod-key ${{ secrets.NEW_RELIC_API_KEY_PRODUCTION }}
    - name: Publish API Docs
      run: npm run publish-docs
